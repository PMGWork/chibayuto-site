---
import { getCollection } from "astro:content";
import path from "path";
import { fileURLToPath } from "url";

// Components
import WorkList from "../components/works/WorkList.tsx";
import Layout from "../layouts/Layout.astro";

const __dirname = path.dirname(fileURLToPath(import.meta.url));

const rawWorks = await getCollection("works");

// 各workのMarkdown本文から最初の画像を抽出してサムネイルを設定
const worksWithThumbnails = await Promise.all(
  rawWorks.map(async (work) => {
    // Markdown本文を取得
    const { body } = work;

    // bodyが存在しない場合はスキップ
    if (!body) {
      return work;
    }

    // Obsidian形式の画像リンクを抽出
    const obsidianImageMatch = body.match(/!\[\[([^\]]+)\]\]/);

    if (obsidianImageMatch) {
      const filename = obsidianImageMatch[1];
      const entryId = work.id.replace(/\.mdx?$/, "");

      // 画像パスを構築 (publicパスとして)
      return {
        ...work,
        data: {
          ...work.data,
          thumbnail: `/works/assets/${entryId}/${filename}`,
        },
      };
    }

    return work;
  }),
);

const works = worksWithThumbnails.sort(
  (a, b) => b.data.endDate.getTime() - a.data.endDate.getTime(),
);

const allTags = [
  ...new Set(works.flatMap((work) => work.data.tags || [])),
] as string[];

const meta = {
  title: "Works | Chiba Yuto",
};
---

<Layout title={meta.title}>
  <div class="text-body-sm sm:text-body-base tracking-wider">
    <main
      class="flex flex-col gap-16 items-center
      px-5 pt-28 pb-4 max-w-dp mx-auto
      sm:items-start sm:px-20 sm:pt-40 sm:pb-10"
    >
      <div class="flex flex-col gap-2 w-full">
        <h1 class="text-4xl text-center sm:text-left">Works</h1>
        <p class="text-xs text-center sm:text-left">作品一覧</p>
      </div>
      <WorkList
        client:visible
        initialTags={allTags}
        initialWorks={works as any}
      />
    </main>
  </div>
</Layout>
