---
import path from 'path';
import { getCollection } from 'astro:content';
import type { Work } from '../types/work';
import { getThumbnailPath } from '../utils/work';

// Components
import WorkList from '../components/works/WorkList.tsx';
import Layout from '../layouts/Layout.astro';

const rawWorks = (await getCollection('works')).filter(
  (work) => !work.id.startsWith('template/')
);

const worksWithThumbnails: Work[] = rawWorks.map((work) => {
  const { thumbnail } = work.data;

  const title = work.filePath
    ? path.basename(work.filePath, path.extname(work.filePath))
    : work.id;

  if (!thumbnail) return { ...work, title };

  const obsidianImageMatch = thumbnail.match(/!?\[\[([^\]]+)\]\]/);
  if (!obsidianImageMatch) return { ...work, title };

  const filename = obsidianImageMatch[1];

  return {
    ...work,
    title,
    thumbnail: getThumbnailPath(work, filename),
  };
});

const works = worksWithThumbnails.sort(
  (a, b) => b.data.createdAt.getTime() - a.data.createdAt.getTime()
);

const allTags = [
  ...new Set(works.flatMap((work) => work.data.tags || [])),
] as string[];

const meta = {
  title: 'Works | Chiba Yuto',
};
---

<Layout title={meta.title}>
  <div class="text-body-sm sm:text-body-base tracking-wider">
    <main
      class="max-w-dp mx-auto flex flex-col items-center gap-16 px-5 pt-28 pb-4 sm:items-start sm:px-20 sm:pt-40 sm:pb-10"
    >
      <div class="flex w-full flex-col gap-2">
        <h1 class="text-center text-4xl sm:text-left">Works</h1>
        <p class="text-center text-xs sm:text-left">作品一覧</p>
      </div>
      <WorkList client:visible initialTags={allTags} initialWorks={works} />
    </main>
  </div>
</Layout>
