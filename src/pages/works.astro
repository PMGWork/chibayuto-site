---
import path from "path";
import { getCollection } from "astro:content";
import type { Work } from "../types/work";
import { getAssetFolderName, getThumbnailPath } from "../utils/work";

// Components
import WorkList from "../components/works/WorkList.tsx";
import Layout from "../layouts/Layout.astro";

const rawWorks = (await getCollection("works")).filter(
  (work) => !work.id.startsWith("template/"),
);

const worksWithThumbnails: Work[] = rawWorks.map((work) => {
  const { thumbnail } = work.data;

  const title = work.filePath
    ? path.basename(work.filePath, path.extname(work.filePath))
    : work.id;

  if (!thumbnail) return { ...work, title };

  const obsidianImageMatch = thumbnail.match(/!?\[\[([^\]]+)\]\]/);
  if (!obsidianImageMatch) return { ...work, title };

  const filename = obsidianImageMatch[1];

  return {
    ...work,
    title,
    thumbnail: getThumbnailPath(work, filename),
  };
});

const works = worksWithThumbnails.sort(
  (a, b) => b.data.endDate.getTime() - a.data.endDate.getTime(),
);

const allTags = [
  ...new Set(works.flatMap((work) => work.data.tags || [])),
] as string[];

const meta = {
  title: "Works | Chiba Yuto",
};
---

<Layout title={meta.title}>
  <div class="text-body-sm sm:text-body-base tracking-wider">
    <main
      class="flex flex-col gap-16 items-center
      px-5 pt-28 pb-4 max-w-dp mx-auto
      sm:items-start sm:px-20 sm:pt-40 sm:pb-10"
    >
      <div class="flex flex-col gap-2 w-full">
        <h1 class="text-4xl text-center sm:text-left">Works</h1>
        <p class="text-xs text-center sm:text-left">作品一覧</p>
      </div>
      <WorkList client:visible initialTags={allTags} initialWorks={works} />
    </main>
  </div>
</Layout>
