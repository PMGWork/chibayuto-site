---
import path from 'path';
import { getCollection } from 'astro:content';
import type { Work } from '../types/work';
import { getThumbnailPath } from '../utils/work';

// コンポーネント
import WorkList from '../components/works/WorkList.tsx';
import Layout from '../layouts/Layout.astro';

// 静的生成
const rawWorks = (await getCollection('works')).filter(
  (work) => !work.id.startsWith('template/'),
);

// 画像最適化
import { getImage } from 'astro:assets';
import { getAssetFolderName } from '../utils/work';
import { getWorkImage } from '../utils/assets';

// サムネイル画像
const worksWithThumbnails: Work[] = await Promise.all(
  rawWorks.map(async (work) => {
    const { thumbnail } = work.data;

    const title = work.filePath
      ? path.basename(work.filePath, path.extname(work.filePath))
      : work.id;

    if (!thumbnail) return { ...work, title };

    const obsidianImageMatch = thumbnail.match(/!?\[\[([^\]]+)\]\]/);
    if (!obsidianImageMatch) return { ...work, title };

    const filename = obsidianImageMatch[1];
    let optimizedImage;

    // 画像最適化処理
    const workId = getAssetFolderName(work);
    const imageMetadata = await getWorkImage(workId, filename);

    if (imageMetadata) {
      const img = await getImage({
        src: imageMetadata,
        format: 'avif',
        quality: 75,
      });
      optimizedImage = {
        src: img.src,
        srcSet: img.srcSet,
        attributes: img.attributes,
      };
    }

    return {
      ...work,
      title,
      thumbnail: getThumbnailPath(work, filename),
      optimizedImage,
    };
  }),
);

// 作品
const works = worksWithThumbnails.sort(
  (a, b) => b.data.createdAt.getTime() - a.data.createdAt.getTime(),
);

// タグ
const allTags = [
  ...new Set(works.flatMap((work) => work.data.tags || [])),
] as string[];

// メタ情報
const meta = {
  title: 'Works | Chiba Yuto',
};
---

<Layout title={meta.title}>
  <div class="text-body-sm sm:text-body-base tracking-wider">
    <main
      class="max-w-dp mx-auto flex flex-col items-center gap-16 px-5 pt-28 pb-4 sm:items-start sm:px-20 sm:pt-40 sm:pb-10"
    >
      <div class="flex w-full flex-col gap-2">
        <h1 class="text-center text-4xl sm:text-left">Works</h1>
        <p class="text-center text-xs sm:text-left">作品一覧</p>
      </div>
      <WorkList client:visible initialTags={allTags} initialWorks={works} />
    </main>
  </div>
</Layout>
