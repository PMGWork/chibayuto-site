---
import path from 'path';
import { getCollection, render } from 'astro:content';
import type { Work } from '../../types/work';
import { getThumbnailPath, getAssetFolderName } from '../../utils/work';
import { getWorkImage } from '../../utils/assets';

// Components
import Layout from '../../layouts/Layout.astro';
import WorkHeader from '../../components/work/WorkHeader.astro';
import WorkImage from '../../components/work/WorkImage.astro';
import Outline from '../../components/work/Outline.astro';

export async function getStaticPaths() {
  const rawWorks = await getCollection('works');

  // テンプレート用のダミー記事は静的生成対象から除外する
  const works: Work[] = rawWorks
    .filter((work) => !work.id.startsWith('template/'))
    .map((work) => {
      const { thumbnail } = work.data;
      if (!thumbnail) return work;

      const obsidianImageMatch = thumbnail.match(/!?\[\[([^\]]+)\]\]/);
      if (!obsidianImageMatch) return work;

      const filename = obsidianImageMatch[1];

      return {
        ...work,
        thumbnail: getThumbnailPath(work, filename),
      };
    });

  return works.map((work: Work) => ({
    params: { work: work.id },
    props: { work },
  }));
}

const { work } = Astro.props as { work: Work };
const { Content, headings } = await render(work);

// filePathからtitleを取得する
const title = work.filePath
  ? path.basename(work.filePath, path.extname(work.filePath))
  : work.id;

const tocHeadings = headings.map((h) => ({
  id: h.slug,
  text: h.text,
  level: h.depth,
}));

const formattedCreatedAt = work.data.createdAt.toISOString();

// サムネイル画像の解決
let thumbnailImageMetadata;
if (work.data.thumbnail) {
  const match = work.data.thumbnail.match(/!?\[\[([^\]]+)\]\]/);
  if (match) {
    const filename = match[1];
    const workId = getAssetFolderName(work);
    thumbnailImageMetadata = await getWorkImage(workId, filename);
  }
}
---

<Layout title={title + ' | Chiba Yuto'}>
  <div class="text-body-sm sm:text-body-base tracking-wider">
    <main
      class="max-w-dp mx-auto flex flex-col items-center px-5 pt-28 pb-4 sm:items-start sm:px-20 sm:pt-40 sm:pb-10"
    >
      <WorkHeader name={title} createdAt={formattedCreatedAt} />
      <WorkImage
        className="mt-8 sm:mt-12"
        name={title}
        image={thumbnailImageMetadata}
        thumbnail={work.thumbnail}
      />

      <div class="mt-12 flex w-full gap-16 sm:mt-20">
        <div
          class="prose prose-sm sm:prose-base flex max-w-none min-w-0 flex-1 flex-col gap-4"
        >
          <Content />
        </div>

        <div class="hidden w-64 flex-shrink-0 lg:block">
          <Outline headings={tocHeadings} />
        </div>
      </div>
    </main>
  </div>
</Layout>
