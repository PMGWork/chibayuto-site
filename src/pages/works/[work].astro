---
import path from "path";
import { getCollection, render } from "astro:content";
import type { Work } from "../../types/work";
import { getAssetFolderName, getThumbnailPath } from "../../utils/work";

// Components
import Layout from "../../layouts/Layout.astro";
import WorkHeader from "../../components/work/WorkHeader.astro";
import WorkImage from "../../components/work/WorkImage.astro";
import TableOfContents from "../../components/work/TableOfContents";

export async function getStaticPaths() {
  const rawWorks = await getCollection("works");

  // テンプレート用のダミー記事は静的生成対象から除外する
  const works: Work[] = rawWorks
    .filter((work) => !work.id.startsWith("template/"))
    .map((work) => {
      const { thumbnail } = work.data;
      if (!thumbnail) return work;

      const obsidianImageMatch = thumbnail.match(/!?\[\[([^\]]+)\]\]/);
      if (!obsidianImageMatch) return work;

      const filename = obsidianImageMatch[1];
      const assetFolderName = getAssetFolderName(work);

      return {
        ...work,
        thumbnail: getThumbnailPath(work, filename),
      };
    });

  return works.map((work: Work) => ({
    params: { work: work.id },
    props: { work },
  }));
}

const { work } = Astro.props as { work: Work };
const { Content, headings } = await render(work);

// Derive title from filePath to preserve casing
const title = work.filePath
  ? path.basename(work.filePath, path.extname(work.filePath))
  : work.id;

const tocHeadings = headings.map((h) => ({
  id: h.slug,
  text: h.text,
  level: h.depth,
}));

const formattedCreatedAt = work.data.createdAt.toISOString();
---

<Layout title={title + " | Chiba Yuto"}>
  <div class="text-body-sm sm:text-body-base tracking-wider">
    <main
      class="flex flex-col items-center sm:items-start
        px-5 pt-28 pb-4 sm:px-20 sm:pt-40 sm:pb-10 max-w-dp mx-auto"
    >
      <WorkHeader name={title} createdAt={formattedCreatedAt} />
      <WorkImage
        className="mt-8 sm:mt-12"
        name={work.id}
        thumbnail={work.thumbnail}
      />

      <div class="w-full mt-12 sm:mt-20 flex gap-16">
        <div
          class="flex-1 flex flex-col min-w-0 gap-4 prose prose-sm sm:prose-base max-w-none"
        >
          <Content />
        </div>

        <div class="hidden lg:block w-64 flex-shrink-0">
          <TableOfContents client:load headings={tocHeadings} />
        </div>
      </div>
    </main>
  </div>
</Layout>
