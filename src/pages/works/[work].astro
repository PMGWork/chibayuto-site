---
import { getCollection, render } from "astro:content";

// Components
import Layout from "../../layouts/Layout.astro";
import WorkHeader from "../../components/work/WorkHeader.astro";
import WorkImage from "../../components/work/WorkImage.astro";
import TableOfContents from "../../components/work/TableOfContents";

export async function getStaticPaths() {
  const rawWorks = await getCollection("works");

  // 各workのMarkdown本文から最初の画像を抽出してサムネイルを設定
  const works = await Promise.all(
    rawWorks.map(async (work) => {
      // Markdown本文を取得
      const { body } = work;

      // bodyが存在しない場合はスキップ
      if (!body) {
        return work;
      }

      // Obsidian形式の画像リンクを抽出
      const obsidianImageMatch = body.match(/!\[\[([^\]]+)\]\]/);

      if (obsidianImageMatch) {
        const filename = obsidianImageMatch[1];
        const entryId = work.id.replace(/\.mdx?$/, "");

        // 画像パスを構築 (publicパスとして)
        return {
          ...work,
          data: {
            ...work.data,
            thumbnail: `/works/assets/${entryId}/${filename}`,
          },
        };
      }

      return work;
    }),
  );

  return works.map((work) => ({
    params: { work: work.id },
    props: { work },
  }));
}

const { work } = Astro.props as { work: any };
const { Content, headings } = await render(work);

const tocHeadings = headings.map((h) => ({
  id: h.slug,
  text: h.text,
  level: h.depth,
}));

const formattedStartDate = work.data.startDate.toISOString();
const formattedEndDate = work.data.endDate.toISOString();
---

<Layout title={work.id + " | Chiba Yuto"}>
  <div class="text-body-sm sm:text-body-base tracking-wider">
    <main
      class="flex flex-col items-center sm:items-start
        px-5 pt-28 pb-4 sm:px-20 sm:pt-40 sm:pb-10 max-w-dp mx-auto"
    >
      <WorkHeader
        name={work.id}
        startDate={formattedStartDate}
        endDate={formattedEndDate}
      />
      <WorkImage
        className="mt-8 sm:mt-12"
        name={work.id}
        thumbnail={work.data.thumbnail}
      />

      <div class="w-full mt-12 sm:mt-20 flex gap-16">
        <div
          class="flex-1 flex flex-col min-w-0 gap-4 prose prose-sm sm:prose-base max-w-none"
        >
          <Content />
        </div>

        <div class="hidden lg:block w-64 flex-shrink-0">
          <TableOfContents client:load headings={tocHeadings} />
        </div>
      </div>
    </main>
  </div>
</Layout>
